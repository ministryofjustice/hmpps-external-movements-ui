{% extends "partials/layout.njk" %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "moj/components/date-picker/macro.njk" import mojDatePicker %}
{% from "partials/hiddenInputs/macro.njk" import hiddenInputs %}
{% from "partials/absenceStatusTag/macro.njk" import absenceStatusTag %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{% from "partials/auditHistory/macro.njk" import auditHistory %}

{% set fullWidth = true %}
{% set pageTitle = 'Manage temporary absence occurrence - Manage temporary absences' %}

{% block innerContent %}
  <div class="govuk-width-container">
    <div class="govuk-grid-row govuk-!-margin-bottom-2">
      <div class="govuk-grid-column-two-thirds">
        <span class="govuk-caption-l">Manage Temporary Absences</span>
        <h1 class="govuk-heading-l">Manage {{ prisonerDetails | firstNameSpaceLastName | possessiveComma }} temporary absence occurrence</h1>

        {% set baseEditUrl = "/temporary-absences/start-edit/" + occurrence.id %}

        <div class="govuk-button-group">
          {% if occurrence.status.code === 'SCHEDULED' and user | hasPermission('TAP', 'MANAGE') %}
            {{ govukButton({
              classes: "govuk-button--warning",
              text: "Cancel this occurrence",
              href: baseEditUrl + "/cancel",
              preventDoubleClick: true
            }) }}
          {% endif %}
        </div>

        {% set viewAbsenceHtml %}
          {{ govukSummaryList({
            card: {
              classes: "govuk-!-margin-bottom-2",
              title: {
                text: "Absence information"
              }
            },
            rows: [
              {
                key: { text: "Occurrence count" },
                value: { text: occurrence.occurrencePosition + ' of ' + occurrence.totalOccurrences }
              } if result.repeat,
              {
                key: { text: "Status" },
                value: { html: absenceStatusTag(occurrence) }
              },
              {
                key: { text: "Start date and time" },
                value: { text: occurrence.start | formatDate("cccc, d MMMM yyyy 'at' HH:mm") },
                actions: { items: [{ href: baseEditUrl + "/start-end-dates#startDate", text: "Change", visuallyHiddenText: "start date and time" }] }
              },
              {
                key: { text: "Return date and time" },
                value: { text: occurrence.end | formatDate("cccc, d MMMM yyyy 'at' HH:mm") },
                actions: { items: [{ href: baseEditUrl + "/start-end-dates#endDate", text: "Change", visuallyHiddenText: "return date and time" }] }
              },
              {
                key: { text: "Absence type" },
                value: { text: occurrence.absenceType.description }
              },
              {
                key: { text: "Absence sub-type" },
                value: { text: occurrence.absenceSubType.description }
              } if occurrence.absenceSubType,
              {
                key: { text: "Absence reason" },
                value: { text: occurrence.absenceReasonCategory.description }
              } if occurrence.absenceReasonCategory,
              {
                key: { text: "Work type" if occurrence.absenceReasonCategory else "Absence reason" },
                value: { text: occurrence.absenceReason.description }
              } if occurrence.absenceReason,
              {
                key: { text: "Single or repeating absence" },
                value: { text: 'Repeating' if result.repeat else 'Single' }
              },
              {
                key: { text: "Repeating pattern type" },
                value: { text: occurrence.scheduleReference.type | repeatTypeLabel }
              } if occurrence.scheduleReference.type,
              {
                key: { text: "Comments" },
                value: { text: (occurrence.comments or "Not provided") | escape | nl2br },
                actions: { items: [{ href: baseEditUrl + "/comments", text: "Change", visuallyHiddenText: "comments" }] }
              },
              {
                key: { text: "Accompanied or unaccompanied" },
                value: { text: occurrence.accompaniedBy.description if occurrence.accompaniedBy.code === 'U' else 'Accompanied' }
              },
              {
                key: { text: "Accompanied by" },
                value: { text: occurrence.accompaniedBy.description }
              } if occurrence.accompaniedBy.code !== 'U',
              {
                key: { text: "Transport" },
                value: { text: occurrence.transport.description },
                actions: { items: [{ href: baseEditUrl + "/transport", text: "Change", visuallyHiddenText: "transport" }] }
              },
              {
                key: { text: "Location" },
                value: { text: occurrence.location | formatAddress },
                actions: { items: [{ href: baseEditUrl + "/location", text: "Change", visuallyHiddenText: "address" }] }
              }
            ] | removeNullish | showChangeLinksIf(user | hasPermission('TAP', 'MANAGE') and editable)
          }) }}
        {% endset -%}

        {{ govukTabs({
          items: [
            {
              label: "Manage occurrence",
              id: "view-absence",
              panel: { html: viewAbsenceHtml }
            },
            {
              label: "Occurrence history",
              id: "absence-history",
              panel: { html: auditHistory({ actions: auditedActions, prisonerName: prisonerDetails | firstNameSpaceLastName }) }
            }
          ]
        }) }}
      </div>

      <div class="govuk-grid-column-one-quarter align-right">
        {% if user | hasPermission('TAP', 'MANAGE') %}
          <h2 class="govuk-heading-m">Related tasks</h2>
          <p><a class="govuk-link govuk-link--no-visited-state" href="/add-temporary-absence/start/{{ prisonerDetails.prisonerNumber }}">Create a new absence for {{ prisonerDetails | firstNameSpaceLastName }}</a></p>
        {% endif %}
      </div>
    </div>

    {% if result.repeat %}
      <p>
        <a class="govuk-link govuk-link--no-visited-state" href="/temporary-absence-authorisations/{{ result.id }}">View all occurrences of this absence</a>
      </p>
      {% if user | hasPermission('TAP', 'MANAGE') and authorisationEditable %}
        <p>
          <a class="govuk-link govuk-link--no-visited-state" href="/temporary-absence-authorisations/start-add-occurrence/{{ result.id }}">Add occurrence</a>
        </p>
      {% endif %}
    {% else %}
      <p>
        <a class="govuk-link govuk-link--no-visited-state" href="/temporary-absence-authorisations/{{ result.id }}">View absence information</a>
      </p>
    {% endif %}
  </div>
{% endblock %}

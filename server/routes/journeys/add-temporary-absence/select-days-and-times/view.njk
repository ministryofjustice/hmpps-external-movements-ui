{% extends "partials/layout.njk" %}
{% from "partials/custom-date-picker/macro.njk" import mojDatePicker %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "partials/validatedTimeInput/macro.njk" import validatedTimeInput %}
{% from "govuk/components/fieldset/macro.njk" import govukFieldset %}
{% from "partials/shift-preview/macro.njk" import shiftPreview %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}

{% set fullWidth = true %}
{% set pageTitle = 'Enter absence dates - Add a temporary absence' %}

{% set absences = absences or [{ startDate: '', startTimeHour: '', startTimeMinute: '', returnDate: '', returnTimeHour: '', returnTimeMinute: '' }] %}

{% block innerContent %}
  <div class="govuk-width-container">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">
        <span class="govuk-caption-l">Create a Temporary Absence</span>
        <h1 class="govuk-heading-l">
          {% if pageCount === 1 %}
            Add absence occurrences taking place from {{ startDate | formatDate('cccc d') }} to {{ endDate | formatDate('cccc d MMMM') }}
          {% else %}
            Month {{ idx }} of {{ pageCount }}: add absence occurrences taking place from {{ startDate | formatDate('cccc d') }} to {{ endDate | formatDate('cccc d MMMM') + (' (optional)' if isOptional else '') }}
          {% endif %}
        </h1>

        <p class="govuk-hint">Add a row for every instance the prisoner will go out in {{ startDate | formatDate('MMMM') }}. For example, if the prisoner is going out 5 times in {{ startDate | formatDate('MMMM') }}, add 5 rows.</p>
        <p class="govuk-hint">If the prisoner is staying out overnight, set the return date to the next or a later day.</p>

        {{ govukInsetText({
          html: "<span>This absence period starts on " + start | formatDate + " and ends on " +  end | formatDate + '. <span><a class="govuk-link govuk-link--no-visited-state" href="' + ('../' if paramsIdx else '' ) + 'start-end-dates">Go back if you need to change these dates.</a>'
        }) }}
      </div>
    </div>

    <form method="post" data-module="moj-add-another" class="add-another-form add-another-form-freeform-pattern-offset">
      <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
      {% for absence in absences %}
        {% call govukFieldset({
          classes: "moj-add-another__item",
          legend: {
            text: "Add absence date and time",
            classes: "moj-add-another__title govuk-fieldset__legend--m",
            isPageHeading: false
          }
        }) %}
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-one-quarter">
              {{ mojDatePicker({
                id: "absences[" + loop.index0 + "][startDate]",
                name: "absences[" + loop.index0 + "][startDate]",
                label: {
                  text: 'Start date',
                  classes: "govuk-fieldset__legend--m"
                },
                hint: {
                  text: 'For example, 17/5/2024.'
                },
                value: absence.startDate,
                errorMessage: validationErrors | findError("absences[" + loop.index0 + "][startDate]"),
                classes: 'hmpps-datepicker--fixed-width govuk-body',
                minDate: startDate | formatInputDate,
                maxDate: endDate | formatInputDate,
                attributes: {
                  "data-id": "absences[%index%][startDate]",
                  "data-name": "absences[%index%][startDate]"
                }
              }) }}
            </div>
            <div class="govuk-grid-column-one-quarter">
              {{ validatedTimeInput({
                addAnother: {
                  id: 'absences',
                  index: loop.index0
                },
                id: "startTime",
                name: "startTime",
                fieldset: {
                  legend: {
                    text: 'Start time',
                    classes: "govuk-fieldset__legend--m"
                  }
                },
                validationErrors: validationErrors,
                hour: absence.startTimeHour,
                minute: absence.startTimeMinute
              }) }}
            </div>
            <div class="govuk-grid-column-one-quarter">
              {{ mojDatePicker({
                id: "absences[" + loop.index0 + "][returnDate]",
                name: "absences[" + loop.index0 + "][returnDate]",
                label: {
                  text: 'Return date',
                  classes: "govuk-fieldset__legend--m"
                },
                hint: {
                  text: 'For example, 17/5/2024.'
                },
                value: absence.returnDate,
                errorMessage: validationErrors | findError("absences[" + loop.index0 + "][returnDate]"),
                classes: 'hmpps-datepicker--fixed-width govuk-body',
                minDate: startDate | formatInputDate,
                maxDate: (endDate | formatInputDate) if isLastMonth else (endDate | addDaysMonths(1) | formatInputDate),
                attributes: {
                  "data-id": "absences[%index%][returnDate]",
                  "data-name": "absences[%index%][returnDate]"
                }
              }) }}
            </div>
            <div class="govuk-grid-column-one-quarter">
              {{ validatedTimeInput({
                addAnother: {
                  id: 'absences',
                  index: loop.index0
                },
                id: "returnTime",
                name: "returnTime",
                fieldset: {
                  legend: {
                    text: 'Return time',
                    classes: "govuk-fieldset__legend--m"
                  }
                },
                validationErrors: validationErrors,
                hour: absence.returnTimeHour,
                minute: absence.returnTimeMinute
              }) }}
            </div>
          </div>

          {% if absences.length > 1 %}
            {{ govukButton({
              name: "remove",
              value: loop.index0,
              text: "Remove",
              classes: "govuk-button--secondary moj-add-another__remove-button"
            }) }}
          {% endif %}
        {% endcall %}
      {% endfor %}

      <div class="moj-button-action">
        {{ govukButton({
          name: "add",
          text: "Add another occurrence",
          classes: "govuk-button--secondary moj-add-another__add-button govuk-!-margin-bottom-4"
        }) }}
      </div>

      {{ govukButton({
        name: "save",
        text: "Continue",
        preventDoubleClick: true
      }) }}
    </form>

    {{ shiftPreview() }}
  </div>
{% endblock %}

{% block pageScripts %}
  <script nonce="{{ cspNonce }}">
    let inputListeners = []
    let changeListeners = []
    const dateFrom = '{{ start }}'
    const dateTo = '{{ end }}'

    const weekFrom = '{{ startDate }}'
    const weekTo = '{{ endDate }}'

    const freeFormPattern = {{ freeFormPattern | dump | safe }}

    function* iterateFreeformPattern(pattern) {
      const mappedPattern = pattern.map(itm => ({
        ...itm,
        type: itm.returnDate > itm.startDate ? 'NIGHT' : 'DAY',
      }))

      const currentDay = new Date(dateFrom)
      while (currentDay.toLocaleDateString('en-CA') <= dateTo) {
        yield mappedPattern.find(({startDate}) => currentDay.toLocaleDateString('en-CA').startsWith(startDate))
        currentDay.setDate(currentDay.getDate() + 1)
      }
      for (;;) yield null
    }

    const setupAutoFillReturnDate = () => document.querySelectorAll('.moj-js-datepicker-input').forEach(el => {
      const index = el.name.match(/absences\[(.+?)]\[startDate]/)?.[1]
      if (index) {
        const returnDateInput = document.querySelector(`input[name="absences[${index}][returnDate]"]`)
        el.addEventListener('change', evt => {
          if (!returnDateInput.value) returnDateInput.value = evt.target.value
        })
      }
    })

    const setupDynamicPreview = (updatePreview) => {
      inputListeners.forEach(([input, listener]) => {
        input.removeEventListener('input', listener)
        input.removeEventListener('change', listener)
      })
      inputListeners = []

      changeListeners.forEach(([input, listener]) => {
        input.removeEventListener('input', listener)
        input.removeEventListener('change', listener)
      })
      changeListeners = []

      document.querySelector('.add-another-form').querySelectorAll('input[name^=absences]').forEach(input => {
        if (input.name.includes('Date')) {
          const handler = () => setTimeout(updatePreview, 100)
          input.addEventListener('change', handler) // selecting a date on Datepicker component only trigger change but not input
          changeListeners.push([input, handler])
        }

        input.addEventListener('input', updatePreview)
        inputListeners.push([input, updatePreview])
      })
    }

    const parseDate = (date) => {
      const parsedDate = new Date(date.split('/').reverse().join('-'))
      if (isNaN(parsedDate)) return null
      return parsedDate.toLocaleDateString('en-CA')
    }

    const parseHourMinute = (hour, minute) => {
      if (!hour && !minute) return ''

      const hourNumber = Number(hour)
      const parsedHour = hour && !Number.isNaN(hourNumber) && hourNumber >= 0 && hourNumber < 24 ? String(hourNumber).padStart(2, '0') : ''
      const minuteNumber = Number(minute)
      const parsedMinute = minute && !Number.isNaN(minuteNumber) && minuteNumber >= 0 && minuteNumber < 60 ? String(minuteNumber).padStart(2, '0') : ''
      return `${parsedHour}:${parsedMinute}`
    }

    window.onload = function () {
      const updatePreview = window.getUpdatePreviewHandler(dateFrom, dateTo, () => {
        const inputs = Array.from(document.querySelector('.add-another-form').querySelectorAll('input[name^=absences]'))
        const rowCount = inputs.length / 6
        const currentWeek = Array.from(new Array(rowCount).keys()).map(idx => {
          const startDate = parseDate(inputs[idx * 6].value)
          const returnDate = parseDate(inputs[idx * 6 + 3].value)
          if (startDate && returnDate) {
            return {
              startDate,
              returnDate,
              startTime: parseHourMinute(inputs[idx * 6 + 1].value, inputs[idx * 6 + 2].value),
              returnTime: parseHourMinute(inputs[idx * 6 + 4].value, inputs[idx * 6 + 5].value),
            }
          }
          return null
        }).filter(itm => Boolean(itm))

        const combinedPattern = [
          ...freeFormPattern.filter(({startDate}) => startDate < weekFrom || startDate > weekTo),
          ...currentWeek,
        ]

        return () => iterateFreeformPattern(combinedPattern)
      })
      updatePreview()

      setupDynamicPreview(updatePreview)
      setupAutoFillReturnDate()

      document.querySelector(".add-another-form").addEventListener('components-init', () => {
        setupAutoFillReturnDate()
        setupDynamicPreview(updatePreview)
      })
    }
  </script>
{% endblock %}
